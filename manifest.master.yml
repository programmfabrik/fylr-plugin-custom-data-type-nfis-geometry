plugin:
  name: custom-data-type-nfis-geometry
  version: 1.3
  url: https://github.com/programmfabrik/fylr-plugin-custom-data-type-nfis-geometry
  displayname:
    de-DE: Geometrieverkn√ºpfung per WFS-T und Masterportal
    en-US: Geometry link via WFS-T and Masterportal
  server:
    api-version:
      require: 1
  webfrontend:
    url: custom-data-type-nfis-geometry.js
    css: custom-data-type-nfis-geometry.css
  l10n: l10n/custom-data-type-nfis-geometry.csv

base_url_prefix: "webfrontend"

custom_types:
  nfis-geometry:
    config:
      schema:
        - name: multi_select
          parameters:
            value:
              type: bool
      mask:
        - name: value
          parameters:
            value:
              type: text
    mapping:
      geometry_ids:
        type: text_oneline
base_config:
  - name: nfisGeoservices
    parameters:
      masterportal_url:
        type: text
        position: 0
      masterportal_version:
        type: select
        options: ["2", "3", "3_use_extent"]
        position: 1
      geoserver_read_username:
        type: text
        position: 2
      geoserver_read_password:
        type: text
        position: 3
      geoserver_write_username:
        type: secret
        position: 4
      geoserver_write_password:
        type: secret
        position: 5
      wfs_geometry_id_field_name:
        type: text
        position: 6
      show_upload_button:
        type: bool
        position: 7
      show_edit_button:
        type: bool
        position: 8
      show_delete_button:
        type: bool
        position: 9
      show_replace_button:
        type: bool
        position: 10
      wfs_marked_for_deletion_field_name:
        type: text
        position: 11
      wfs_replaced_by_field_name:
        type: text
        position: 12
      wfs_temporary_geometry_field_name:
        type: text
        position: 13
      temporary_geometry_tag_id:
        type: int
        position: 14
      wfs_configuration:
        type: table
        fields:
          - name: object_type
            type: text
            position: 0
          - name: geometry_fields
            type: table
            fields:
              - name: field_path
                type: text
                position: 0
              - name: sld_file
                type: file
                position: 1
              - name: legend_image_file
                type: file
                position: 2
              - name: display_wfs_url
                type: text
                position: 3
              - name: display_wfs_feature_type
                type: text
                position: 4
              - name: edit_wfs_url
                type: text
                position: 5
              - name: edit_wfs_feature_type
                type: text
                position: 6
              - name: add_icon_points_to_polygons
                type: bool
                position: 7
              - name: masterportal_raster_layer_id
                type: text
                position: 8
              - name: masterportal_vector_layer_field_name
                type: text
                position: 9
              - name: masterportal_vector_layer_ids
                type: table
                fields:
                  - name: field_value
                    type: text
                    position: 0
                  - name: group_id
                    type: int
                    position: 1
                  - name: layer_id
                    type: text
                    position: 2
                position: 10
              - name: send_data_to_geoserver
                type: bool
                position: 11
              - name: fields
                type: table
                fields:
                  - name: wfs_field_name
                    type: text
                    position: 0
                  - name: fylr_field_name
                    type: text
                    position: 1
                  - name: fylr_function
                    type: text
                    position: 2
                position: 12
              - name: tags
                type: table
                fields:
                  - name: wfs_field_name
                    type: text
                    position: 0
                  - name: fylr_tags_path
                    type: text
                    position: 1
                  - name: fylr_tag_id
                    type: int
                    position: 2
                  - name: wfs_field_value
                    type: text
                    position: 3
                position: 13
              - name: wfs_pool_field
                type: text
                position: 14
              - name: pool_names
                type: table
                fields:
                  - name: pool_name
                    type: text
                    position: 0
                position: 15
            position: 1
        position: 15
      linked_objects:
        type: table
        fields:
          - name: object_type
            type: text
            position: 0
          - name: link_field_name
            type: text
            position: 1
        position: 16
      masterportal_configurations:
        type: table
        fields:
          - name: group_id
            type: int
            position: 0
          - name: file_name
            type: text
            position: 1
        position: 17

callbacks:
  db_pre_save:
    steps:
      - name: "Send updated data to Geoserver"
        callback: sendDataToGeoserver
    callbacks:
      sendDataToGeoserver:
        exec:
          service: "node"
          commands:
            - prog: "node"
              stdin:
                type: body
              stdout:
                type: body
              args:
                - type: "value"
                  value: "%_exec.pluginDir%/server/sendDataToGeoserver.js"
                - type: "value"
                  value: "%info.json%"
